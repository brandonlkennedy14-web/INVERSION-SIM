<!DOCTYPE html>
<html>
<head>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: monospace; display: flex; flex-direction: column; height: 100vh; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; height: 80vh; gap: 2px; background: #222; }
        .panel { background: #000; position: relative; overflow: hidden; border: 1px solid #444; }
        .label { position: absolute; top: 2px; left: 2px; font-size: 8px; color: #0f0; z-index: 10; background: #000; padding: 2px; }
        #controls { height: 20vh; background: #111; padding: 10px; border-top: 1px solid #0f0; display: flex; flex-direction: column; gap: 5px; box-sizing: border-box; }
        .row { display: flex; align-items: center; gap: 10px; width: 100%; }
        .btn { flex: 1; background: #222; color: #0f0; border: 1px solid #0f0; padding: 8px; cursor: pointer; font-size: 10px; font-weight: bold; }
        #status { font-size: 9px; color: #f0f; text-align: center; }
    </style>
</head>
<body>
    <div class="grid">
        <div class="panel" id="p1"><span class="label">SIM-1: FLEET_9_IMBALANCE</span></div>
        <div class="panel" id="p2"><span class="label">SIM-2: ATTENTION_HEATMAP</span></div>
        <div class="panel" id="p3"><span class="label">SIM-3: HYPERBOLIC_LOSS</span></div>
    </div>
    <div id="controls">
        <div class="row"><strong>FLEET_ENTROPY:</strong> <input type="range" id="warp" min="1" max="500" value="150" style="flex:2"></div>
        <div class="row">
            <button class="btn" id="saveBtn">ðŸ’¾ LOG ATTENTION</button>
            <button class="btn" id="syncBtn">ðŸ“¡ SYNC FIELD</button>
            <button class="btn" onclick="location.reload()">ðŸ”„ REBOOT</button>
        </div>
        <div id="status">NEURAL_LINK_ESTABLISHED</div>
    </div>

    <script type="importmap">
    { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "supabase": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm" } }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { createClient } from 'supabase';

        const sb = createClient('https://xoolmbmnzbsvcqeyqvyi.supabase.co', 'sb_publishable_A1cLFAKbAg77TfTkD2RB-w_PahU316T');
        const status = document.getElementById('status');
        const warpSlider = document.getElementById('warp');

        function setup(id, is3D) {
            const el = document.getElementById(id);
            const scene = new THREE.Scene();
            const cam = is3D ? new THREE.PerspectiveCamera(75, el.clientWidth/el.clientHeight, 0.1, 100) : new THREE.OrthographicCamera(-2.5,2.5,2.5,-2.5,0.1,100);
            const ren = new THREE.WebGLRenderer({ antialias: true });
            ren.setSize(el.clientWidth, el.clientHeight);
            el.appendChild(ren.domElement);
            cam.position.z = 5;
            return { scene, cam, ren };
        }

        const s1 = setup('p1', false); const s2 = setup('p2', false); const s3 = setup('p3', true);
        const attentionMap = new THREE.Group(); s2.scene.add(attentionMap);
        s3.scene.add(new THREE.BoxHelper(new THREE.Mesh(new THREE.BoxGeometry(4,4,4)), 0x00ff00));

        const bots = [];
        for(let i=0; i<9; i++) {
            const bot = {
                pos: new THREE.Vector3((Math.random()-0.5)*2, (Math.random()-0.5)*2, 0),
                vel: new THREE.Vector3((Math.random()-0.5)*0.05, (Math.random()-0.5)*0.05, (Math.random()-0.5)*0.02),
                trail: [],
                line: new THREE.Line(new THREE.BufferGeometry(), new THREE.LineBasicMaterial({ color: new THREE.Color().setHSL(i/9, 0.8, 0.5), transparent: true, opacity: 0.5 })),
                mesh: new THREE.Mesh(new THREE.SphereGeometry(0.08), new THREE.MeshBasicMaterial({color: 0x00ff00}))
            };
            s1.scene.add(bot.line);
            s3.scene.add(bot.mesh);
            bots.push(bot);
        }

        document.getElementById('saveBtn').onclick = async () => {
            status.innerText = "UPLOADING FIELD...";
            const data = bots.map(b => b.trail.map(p => ({x:p.x, y:p.y})));
            await sb.from('jobs').insert([{ variant_name: 'sim3colts', config: { entropy: warpSlider.value }, result: { logs: data } }]);
            status.innerText = "FIELD ARCHIVED";
        };

        document.getElementById('syncBtn').onclick = async () => {
            const { data } = await sb.from('jobs').select('result').eq('variant_name', 'sim3colts').order('created_at', { ascending: false }).limit(5);
            while(attentionMap.children.length > 0){ attentionMap.remove(attentionMap.children[0]); }
            if (data) {
                data.forEach((run, idx) => {
                    run.result.logs.forEach(log => {
                        const geo = new THREE.BufferGeometry().setFromPoints(log.map(p => new THREE.Vector3(p.x, p.y, 0)));
                        const mat = new THREE.LineBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.05 });
                        attentionMap.add(new THREE.Line(geo, mat));
                    });
                });
                status.innerText = "ATTENTION_FIELD_SYNCED";
            }
        };

        function loop() {
            let e = warpSlider.value / 1000;
            bots.forEach(b => {
                let dist = 2 - Math.max(Math.abs(b.pos.x), Math.abs(b.pos.y));
                let cur = e / (dist + 0.05);
                b.vel.x += Math.sin(b.pos.y * cur) * 0.01;
                b.vel.y += Math.cos(b.pos.x * cur) * 0.01;
                b.pos.add(b.vel);
                if (Math.abs(b.pos.x) > 2) b.vel.x *= -1;
                if (Math.abs(b.pos.y) > 2) b.vel.y *= -1;
                b.mesh.position.copy(b.pos);
                b.trail.push(b.pos.clone()); if (b.trail.length > 100) b.trail.shift();
                b.line.geometry.setFromPoints(b.trail);
            });
            s1.ren.render(s1.scene, s1.cam); s2.ren.render(s2.scene, s2.cam); s3.ren.render(s3.scene, s3.cam);
            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>
</html>
