<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INVERSION-SIM | 3D Monitor</title>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: monospace; overflow: hidden; }
        #ui { position: absolute; top: 10px; left: 10px; z-index: 10; pointer-events: none; }
        #debug { position: absolute; top: 100px; left: 10px; color: red; font-size: 12px; }
        canvas { display: block; }
    </style>
</head>
<body>
    <div id="ui">
        <h1>SIM-3: MONITOR</h1>
        <div id="status">INIT...</div>
    </div>
    <div id="debug"></div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "supabase": "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { createClient } from 'supabase';

        const debug = document.getElementById('debug');
        const status = document.getElementById('status');

        try {
            // 1. Scene Setup
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            camera.position.z = 20;

            // 2. Prime Barriers
            const levels = [2, 3, 5, 7, 11, 13, 17, 19];
            levels.forEach(l => {
                const mesh = new THREE.Mesh(
                    new THREE.PlaneGeometry(20, 20),
                    new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.1, side: THREE.DoubleSide })
                );
                mesh.position.z = -l;
                scene.add(mesh);
            });

            // 3. Grid
            scene.add(new THREE.GridHelper(50, 50, 0x222222, 0x111111));

            // 4. Supabase Connection
            const sb = createClient('https://xoolmbmnzbsvcqeyqvyi.supabase.co', 'sb_publishable_A1cLFAKbAg77TfTkD2RB-w_PahU316T');
            status.innerText = "LINKED TO SUPABASE";

            // 5. Animation
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();

            // 6. Data Pulling
            async function pull() {
                const { data, error } = await sb.from('jobs').select('*').eq('status', 'completed').order('completed_at', { ascending: false }).limit(1).single();
                if (data && data.result.log) {
                    status.innerText = "VIEWING: " + data.id.substring(0,8);
                    draw(data.result.log);
                }
                if (error) debug.innerText = "SB Error: " + error.message;
            }

            function draw(log) {
                // Clear old lines
                scene.children.filter(c => c.type === "Line").forEach(l => scene.remove(l));
                const pts = log.map(e => new THREE.Vector3(e.step * 0.01, Math.sin(e.step*0.1)*2, -e.phi));
                const geo = new THREE.BufferGeometry().setFromPoints(pts);
                scene.add(new THREE.Line(geo, new THREE.LineBasicMaterial({ color: 0x00ffff })));
            }

            setInterval(pull, 5000);
            pull();

        } catch (e) {
            debug.innerText = "JS CRASH: " + e.message;
        }
    </script>
</body>
</html>